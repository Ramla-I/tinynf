# make sure it's the right ver for papi, the latest commits are broken
git checkout papi-5-7-0-t

# otherwise there are no counters
echo 0 | sudo tee /proc/sys/kernel/perf_event_paranoid

# for both
# - start 'sudo ./moon-gen/build/MoonGen ./tinynf-benchmarking/bench-moongen.lua flood 2' on s4 before!

# for tinynf
TN_CFLAGS='-DTN_DEBUG_PERF=10010000 -flto -DIXGBE_AGENT_OUTPUTS_MAX=1 -DTRUE_NOP' TN_LDFLAGS='-lpapi -flto' TN_DEBUG=0 make
sudo taskset -c 8 ./tinynf 83:00.0 85:00.0 >loglog 2>&1

# for DPDK
# - bind the right dpdk interfaces on s3
EXTRA_CFLAGS='-DTN_DEBUG_PERF=10010000 -DBATCH_SIZE=1' EXTRA_LDFLAGS='-lpapi' make
EXTRA_CFLAGS='-DTN_DEBUG_PERF=10010000 -DBATCH_SIZE=32' EXTRA_LDFLAGS='-lpapi' make
sudo taskset -c 8 ./build/app/nf --no-shconf -n 2 -- >loglog 2>&1

# analyzing the log: ignore until after the line with the counters header, and skip the first batch (note that tail skips up to N exclusive)
for i in $(seq 1 6); do sed -e '0,/Counters:/d' loglog | tail -n +10001 | awk "{print \$$i}" | ministat -A; done
